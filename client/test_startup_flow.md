# 启动流程测试指南

## 新的启动逻辑

现在应用启动后会按照以下流程：

### 1. 加载配置阶段 (AppInitState.loading)
- 显示：加载动画 + "正在加载配置..."
- 行为：从SharedPreferences读取server_url和api_token

### 2. 根据配置状态决定下一步

#### 2.1 未配置 (AppInitState.needsSetup)
- **触发条件**：server_url为空
- **显示内容**：SetupPromptWidget 配置引导界面
  - 欢迎卡片
  - 服务器地址输入框
  - API Token输入框（可选）
  - 连接按钮
  - 配置示例
- **AppBar**：只显示主题切换按钮

#### 2.2 已配置但有错误 (AppInitState.error)  
- **触发条件**：配置加载过程中出错
- **显示内容**：EnhancedErrorWidget 错误界面
- **AppBar**：只显示主题切换按钮

#### 2.3 配置正常 (AppInitState.ready)
- **触发条件**：server_url不为空
- **行为**：
  1. 配置API和WebSocket服务
  2. 尝试连接并加载节点数据
  3. 启动自动刷新
- **显示内容**：
  - 如果正在加载：加载动画 + "正在加载节点数据..."
  - 如果有错误：EnhancedErrorWidget（连接错误等）
  - 如果无数据：友好的空状态页面
  - 如果有数据：节点列表
- **AppBar**：显示完整功能（主题切换 + 连接状态 + 刷新按钮）

## 测试步骤

### 测试场景1：首次启动（无配置）
1. 清空应用数据或使用新设备
2. 启动应用
3. **预期结果**：直接显示SetupPromptWidget配置界面

### 测试场景2：配置有效地址
1. 在配置界面输入：`http://localhost:9999/api/v1`
2. 点击"连接服务器"
3. **预期结果**：
   - 如果服务器在线：跳转到节点列表页面
   - 如果服务器离线：显示连接错误界面

### 测试场景3：已配置但服务器离线
1. 应用已配置但服务器未启动
2. 启动应用
3. **预期结果**：
   - 先显示"正在加载节点数据..."
   - 然后显示网络连接错误界面
   - 可以点击重试

### 测试场景4：配置更改
1. 在已配置状态下进入设置页面
2. 修改服务器地址
3. 保存设置
4. **预期结果**：自动重新连接新地址

## 用户体验改进

### ✅ 已实现
- 智能启动检查：根据配置状态显示不同界面
- 友好的配置引导：一步到位的设置界面
- 清晰的状态提示：不同加载阶段有不同提示文本
- 条件显示AppBar：未配置时隐藏不必要的按钮
- 错误状态处理：网络错误时显示专业的错误界面

### 🎯 核心改进
- **消除困惑**：用户不会再看到"空节点列表"而不知道怎么办
- **引导明确**：首次使用直接显示配置界面
- **反馈及时**：每个步骤都有明确的状态提示
- **操作简单**：一个界面完成所有配置