# Server Manager (Core + Node)

ä¸€ä¸ª **è½»é‡çº§ã€å¼€ç®±å³ç”¨** çš„åˆ†å¸ƒå¼æœåŠ¡å™¨ç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨ **Rust** ç¼–å†™ã€‚é¡¹ç›®åŒæ—¶åŒ…å«ï¼š

* **Core (æœåŠ¡ç«¯)**ï¼šç®¡ç†èŠ‚ç‚¹æ³¨å†Œã€ç›‘æ§ã€å‘½ä»¤åˆ†å‘ã€æ—¥å¿—å­˜å‚¨
* **Node (èŠ‚ç‚¹ä»£ç†)**ï¼šè¿è¡Œåœ¨èŠ‚ç‚¹æœåŠ¡å™¨ï¼Œé‡‡é›†ç³»ç»Ÿä¿¡æ¯å¹¶æ‰§è¡Œè¿œç¨‹å‘½ä»¤

å®¢æˆ·ç«¯ä½¿ç”¨ **Flutter**ï¼Œå¯è¦†ç›–ç§»åŠ¨ç«¯ã€æ¡Œé¢ç«¯å’Œ Web é¡µé¢ã€‚

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
server-manager/
â”œâ”€â”€ core/                      # æ ¸å¿ƒæœåŠ¡ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/               # REST API å±‚
â”‚   â”‚   â”œâ”€â”€ ws/                # WebSocket é€šä¿¡å±‚
â”‚   â”‚   â”œâ”€â”€ scheduler/         # ä»»åŠ¡è°ƒåº¦ä¸å‘½ä»¤åˆ†å‘
â”‚   â”‚   â”œâ”€â”€ storage/           # SQLite & Redis æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹ (èŠ‚ç‚¹/å‘½ä»¤/æ—¥å¿—)
â”‚   â”‚   â”œâ”€â”€ security/          # è®¤è¯ã€TLSã€å®‰å…¨ç­–ç•¥
â”‚   â”‚   â””â”€â”€ main.rs            # Core å…¥å£
â”‚   â””â”€â”€ Cargo.toml
â”‚
â”œâ”€â”€ node/                      # èŠ‚ç‚¹ä»£ç†
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ agent/             # èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸç®¡ç† (æ³¨å†Œ/å¿ƒè·³)
â”‚   â”‚   â”œâ”€â”€ collector/         # ç³»ç»Ÿä¿¡æ¯é‡‡é›† (CPU/å†…å­˜/ç£ç›˜/ç½‘ç»œ)
â”‚   â”‚   â”œâ”€â”€ executor/          # è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (Shell/æœåŠ¡ç®¡ç†)
â”‚   â”‚   â”œâ”€â”€ transport/         # é€šä¿¡å±‚ (WebSocket/HTTP)
â”‚   â”‚   â””â”€â”€ main.rs            # Node å…¥å£
â”‚   â””â”€â”€ Cargo.toml
â”‚
â”œâ”€â”€ common/                    # Core å’Œ Node å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ proto/             # æ¶ˆæ¯åè®®å®šä¹‰ (JSON/WS æ ¼å¼)
â”‚   â”‚   â”œâ”€â”€ config/            # é…ç½®è§£æ (TOML)
â”‚   â”‚   â”œâ”€â”€ utils/             # å·¥å…·åº“
â”‚   â”‚   â””â”€â”€ lib.rs
â”‚   â””â”€â”€ Cargo.toml
â”‚
â”œâ”€â”€ client/                    # Flutter å®¢æˆ·ç«¯ (å¯é€‰åœ¨æ­¤æˆ–ç‹¬ç«‹ä»“åº“)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ Cargo.toml                 # workspace é…ç½®
â””â”€â”€ README_SERVER.md           # æœåŠ¡ç«¯è¯´æ˜
```

---

## ğŸ§© æ¨¡å—è¯´æ˜

### Coreï¼ˆæœåŠ¡ç«¯ï¼‰

* **api/**ï¼šæä¾› REST APIï¼ˆèŠ‚ç‚¹æŸ¥è¯¢ã€å‘½ä»¤ä¸‹å‘ã€å†å²æ•°æ®æŸ¥è¯¢ï¼‰
* **ws/**ï¼šWebSocket é€šé“ï¼Œç»´æŒä¸èŠ‚ç‚¹çš„å®æ—¶è¿æ¥
* **scheduler/**ï¼šä»»åŠ¡è°ƒåº¦ä¸­å¿ƒï¼Œè´Ÿè´£å‘½ä»¤åˆ†å‘å’Œå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
* **storage/**ï¼šSQLite å­˜å‚¨ç›‘æ§æ•°æ® & Redis ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜
* **models/**ï¼šå®šä¹‰èŠ‚ç‚¹ã€å‘½ä»¤ã€æ—¥å¿—çš„æ•°æ®ç»“æ„
* **security/**ï¼šå¯†é’¥ç”Ÿæˆä¸éªŒè¯ã€TLS é€šä¿¡å®‰å…¨

### Nodeï¼ˆèŠ‚ç‚¹ä»£ç†ï¼‰

* **agent/**ï¼šèŠ‚ç‚¹æ³¨å†Œã€å¿ƒè·³ç»´æŠ¤ã€çŠ¶æ€åŒæ­¥
* **collector/**ï¼šç³»ç»Ÿä¿¡æ¯é‡‡é›†ï¼ˆCPU/å†…å­˜/ç£ç›˜/ç½‘ç»œ IOï¼‰
* **executor/**ï¼šæ‰§è¡Œæ¥è‡ª Core çš„å‘½ä»¤ï¼ˆShellã€æœåŠ¡ç®¡ç†ï¼‰
* **transport/**ï¼šé€šä¿¡æ¨¡å—ï¼Œè´Ÿè´£ä¸ Core å»ºç«‹ WS é•¿è¿æ¥

### Commonï¼ˆå…±äº«åº“ï¼‰

* **proto/**ï¼šå®šä¹‰ Core <-> Node çš„æ¶ˆæ¯æ ¼å¼
* **config/**ï¼šç»Ÿä¸€çš„é…ç½®åŠ è½½æ¨¡å—ï¼ˆæ”¯æŒ TOMLï¼‰
* **utils/**ï¼šæ—¥å¿—ã€é”™è¯¯å¤„ç†ã€å·¥å…·å‡½æ•°

---

## ğŸ”‘ å®‰å…¨ä¸æ³¨å†Œé€»è¾‘

### Core å¯åŠ¨

* Core å¯åŠ¨æ—¶ä¼šæ£€æŸ¥æ˜¯å¦å·²æœ‰å¯†é’¥æ–‡ä»¶ï¼ˆä¾‹å¦‚ `./data/core.key`ï¼‰ã€‚
* å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°çš„éšæœºå¯†é’¥å¹¶ä¿å­˜åˆ°æ–‡ä»¶ã€‚
* Core ä½¿ç”¨è¯¥å¯†é’¥æ¥æ ¡éªŒæ‰€æœ‰èŠ‚ç‚¹æ³¨å†Œå’Œå®¢æˆ·ç«¯è¯·æ±‚ã€‚

### åˆ†å‘å¯†é’¥

* ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ CLI æŸ¥çœ‹/å¯¼å‡ºå¯†é’¥ï¼š

  ```bash
  ./server-manager-core key show
  # è¾“å‡º: abcdef123456...
  ```
* å°†æ­¤å¯†é’¥é…ç½®åˆ° Node (`config-node.toml`) æˆ–å®¢æˆ·ç«¯åº”ç”¨ä¸­ã€‚

### Node æ³¨å†Œ

* Node å¯åŠ¨æ—¶ï¼Œè¯»å– `config-node.toml` ä¸­çš„ `register_token`ã€‚
* Node â†’ Core å‘èµ·æ³¨å†Œè¯·æ±‚ï¼Œæºå¸¦å¯†é’¥ã€‚
* Core éªŒè¯æˆåŠŸåï¼Œåˆ†é… Node ID å¹¶å…è®¸å»ºç«‹ WS é•¿è¿æ¥ã€‚

### å®¢æˆ·ç«¯è®¿é—®

* Flutter å®¢æˆ·ç«¯åœ¨é¦–æ¬¡è¿æ¥æ—¶ï¼Œéœ€è¦æä¾›åŒä¸€å¯†é’¥ã€‚
* Core éªŒè¯åæ‰å…è®¸æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€ã€ä¸‹å‘å‘½ä»¤ã€‚

---

## âš™ï¸ å·¥ä½œæµç¨‹

### èŠ‚ç‚¹æ³¨å†Œ

1. Core å¯åŠ¨å¹¶ç”Ÿæˆ/åŠ è½½å¯†é’¥
2. Node å¯åŠ¨ â†’ è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„å¯†é’¥
3. Node â†’ Core å‘é€æ³¨å†Œè¯·æ±‚
4. Core éªŒè¯æˆåŠŸ â†’ åˆ†é… Node ID â†’ è¿”å›æ³¨å†ŒæˆåŠŸ

### å¿ƒè·³ä¸ç›‘æ§

1. Node å‘¨æœŸæ€§é‡‡é›†ç³»ç»Ÿä¿¡æ¯
2. Node â†’ Core å‘é€å¿ƒè·³åŒ…ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰ï¼‰
3. Core å­˜å‚¨ç›‘æ§æ•°æ®åˆ° SQLiteï¼ŒåŒæ—¶å†™å…¥ Redis ç¼“å­˜
4. å®¢æˆ·ç«¯é€šè¿‡ API/WS æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€

### å‘½ä»¤ä¸‹å‘ä¸æ‰§è¡Œ

1. å®¢æˆ·ç«¯ â†’ Core è¯·æ±‚æ‰§è¡Œå‘½ä»¤
2. Core â†’ Node ä¸‹å‘æ‰§è¡Œä»»åŠ¡ï¼ˆé€šè¿‡ WSï¼‰
3. Node â†’ æœ¬åœ°æ‰§è¡Œå‘½ä»¤ï¼ˆexecutor æ¨¡å—ï¼‰
4. Node â†’ Core è¿”å›æ‰§è¡Œç»“æœ
5. Core â†’ å­˜å‚¨æ—¥å¿— & æ¨é€å®¢æˆ·ç«¯

---

## ğŸ— æ¶æ„å›¾

```mermaid
flowchart TD
    subgraph Client[å®¢æˆ·ç«¯ - Flutter]
        F1[ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯/Web]
    end

    subgraph Core[Core æœåŠ¡ç«¯ - Rust]
        A1[API å±‚]
        A2[WebSocket ç½‘å…³]
        A3[ä»»åŠ¡è°ƒåº¦å™¨]
        A4[å­˜å‚¨: SQLite/Redis]
        A5[å¯†é’¥ç”Ÿæˆä¸éªŒè¯]
    end

    subgraph Node[Node èŠ‚ç‚¹ä»£ç† - Rust]
        B1[Agent æ³¨å†Œ & å¿ƒè·³]
        B2[ç³»ç»Ÿé‡‡é›† Collector]
        B3[å‘½ä»¤æ‰§è¡Œ Executor]
        B4[Transport é€šä¿¡]
    end

    F1 --> A1
    A1 --> A4
    A2 <--> B1
    A2 <--> B2
    A2 <--> B3
    A2 --> A3
    A3 --> A4
    A5 --> A1
    A5 --> A2
```

---

## ğŸ”¨ æ„å»ºä¸è¿è¡Œ

### æ„å»º

```bash
git clone https://github.com/your-org/server-manager.git
cd server-manager
cargo build --release
```

### å¯åŠ¨ Core æœåŠ¡

```bash
./target/release/server-manager-core --config ./config-core.toml

# æŸ¥çœ‹ Core ç”Ÿæˆçš„å¯†é’¥
./target/release/server-manager-core key show
```

### å¯åŠ¨ Node ä»£ç†

```bash
./target/release/server-manager-node --config ./config-node.toml
```

---

## ğŸ“‘ é…ç½®æ–‡ä»¶ç¤ºä¾‹

### Core é…ç½® (`config-core.toml`)

```toml
[server]
listen = "127.0.0.1:9999"

[storage]
sqlite_path = "./data/server_manager.db"
redis_url = "redis://127.0.0.1:6379"
```

### Node é…ç½® (`config-node.toml`)

```toml
[node]
core_addr = "ws://127.0.0.1:9999"
register_token = "abcdef123456"   # ä» Core å¯¼å‡ºçš„å¯†é’¥
hostname = "node-01"
```
