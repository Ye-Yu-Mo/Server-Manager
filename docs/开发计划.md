# Server Manager 开发计划

## 项目概述

Server Manager 是一个分布式服务器监控管理系统，采用 Rust + Flutter 技术栈。

### 系统架构

```
┌─────────────┐    WebSocket    ┌──────────────┐    RESTful API    ┌─────────────┐
│    Node     │ ──────────────> │     Core     │ <──────────────── │   Client    │
│  (监控代理)   │    实时推送     │   (核心服务)   │     手动刷新      │  (管理界面)   │
└─────────────┘                └──────────────┘                  └─────────────┘
```


## 当前系统状态

### ✅ 已完成功能

#### 1. 服务器端 (Rust)
- **Core 服务**：
  - WebSocket 服务端实现
  - RESTful API 完整实现
  - SQLite 数据库集成
  - 节点注册和管理
  - 监控数据存储
  - 健康检查端点

- **Node 代理**：
  - 系统监控数据采集 (CPU/内存/磁盘/运行时间)
  - WebSocket 客户端实现
  - 自动重连机制
  - 心跳保持
  - 配置文件支持

#### 2. 客户端 (Flutter)
- **界面功能**：
  - 节点列表展示
  - 实时监控数据显示
  - 节点详情页面
  - 暗黑模式支持
  - 设置页面

- **数据管理**：
  - 完整的 RESTful API 调用
  - Provider 状态管理
  - 数据持久化 (SharedPreferences)

## 开发计划

### 阶段一：客户端实时更新 (高优先级)

#### 1.1 WebSocket 客户端集成
- [x] 添加 `web_socket_channel` 依赖
- [x] 实现 WebSocket 客户端服务
- [x] 创建连接管理和断线重连机制
- [x] 集成到 NodeProvider 中

#### 1.2 实时数据推送
- [x] 服务端添加客户端 WebSocket 支持
- [x] 实现监控数据广播机制
- [ ] 节点状态变化推送
- [ ] 自动更新 UI 数据

#### 1.3 配置功能实现
- [ ] 将设置页面的自动刷新配置连接到实际功能
- [ ] 支持自动刷新开关控制
- [ ] 支持刷新间隔设置 (5秒/10秒/15秒/30秒)
- [ ] 保持 RESTful API 作为备用方案

### 阶段二：功能增强 (中优先级)

#### 2.1 界面优化
- [ ] 添加连接状态指示器
- [ ] 实时数据动画效果
- [ ] 网络状态监控
- [ ] 错误重试机制

#### 2.2 监控功能扩展
- [ ] 历史数据图表 (基于现有 fl_chart)
- [ ] 自定义监控指标
- [ ] 告警阈值设置
- [ ] 通知推送

#### 2.3 节点管理
- [ ] 批量操作支持
- [ ] 节点分组功能
- [ ] 标签和过滤
- [ ] 远程命令执行界面

### 阶段三：高级功能 (低优先级)

#### 3.1 安全性增强
- [ ] JWT 认证替换固定 token
- [ ] 权限管理系统
- [ ] HTTPS/WSS 支持
- [ ] API 访问控制

#### 3.2 扩展性
- [ ] 插件系统
- [ ] 自定义指标收集
- [ ] 第三方集成 (Prometheus/Grafana)
- [ ] 集群部署支持

#### 3.3 运维功能
- [ ] 日志聚合和查看
- [ ] 配置管理
- [ ] 备份和恢复
- [ ] 性能分析

## 技术方案

### WebSocket 实时更新实现

#### 客户端架构
```dart
WebSocketService
├── 连接管理
├── 消息处理
├── 断线重连
└── 状态同步

NodeProvider (扩展)
├── WebSocket 集成
├── 实时数据更新
├── 降级到 RESTful
└── 配置驱动刷新
```

#### 服务端扩展
```rust
// Core 服务添加客户端 WebSocket 端点
/ws/client?token=xxx&type=monitor

// 广播机制
监控数据变化 → 推送给所有连接的客户端
节点状态变化 → 实时更新客户端界面
```

### 数据流优化

#### 实时更新流程
```
Node → [WebSocket] → Core → Database
                            ↓
Client ← [WebSocket] ← Core (广播监控数据变化)
```

#### 降级方案
- WebSocket 连接失败时自动切换到 RESTful API
- 支持手动刷新模式
- 保持现有所有功能兼容性

## 开发时间表

### 第 1 周：WebSocket 客户端基础
- [ ] 依赖添加和环境配置
- [ ] WebSocket 客户端服务实现
- [ ] 基础连接测试

### 第 2 周：实时数据集成
- [ ] NodeProvider WebSocket 集成
- [ ] 服务端客户端 WebSocket 端点
- [ ] 实时数据推送测试

### 第 3 周：配置功能和测试
- [ ] 自动刷新配置实现
- [ ] 界面优化和状态指示
- [ ] 完整功能测试

### 第 4 周：错误处理和优化
- [ ] 断线重连机制
- [ ] 错误处理完善
- [ ] 性能优化

## 成功指标

### 功能指标
- [ ] 客户端能够实时接收监控数据更新
- [ ] 自动刷新配置生效
- [ ] WebSocket 断线自动重连
- [ ] 降级到 RESTful API 无缝切换

### 性能指标
- [ ] WebSocket 连接延迟 < 100ms
- [ ] 数据推送间隔可配置 (15-300秒)
- [ ] 内存使用增长 < 10%
- [ ] 电池消耗优化

### 用户体验指标
- [ ] 数据刷新无需用户手动操作
- [ ] 连接状态清晰可见
- [ ] 网络异常时用户感知良好
- [ ] 设置页面配置即时生效

---

## 备注

1. **优先级**：实时更新功能是当前最高优先级，直接影响用户体验
2. **兼容性**：保持现有 RESTful API 功能完整，WebSocket 作为增强
3. **渐进式**：可以先实现基础 WebSocket 功能，再逐步优化
4. **测试驱动**：每个阶段都要有对应的测试用例

最后更新：2025-01-21