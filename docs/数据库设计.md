# 分布式服务器管理系统 - 数据库设计 (MVP版本)

## MVP核心功能
- ✅ 节点注册与状态管理
- ✅ 基础监控数据采集  
- ✅ 远程命令执行
- ❌ 用户权限管理 (使用简单token认证)
- ❌ 审计日志 (后续版本添加)
- ❌ 告警系统 (后续版本添加)
- ❌ 节点分组 (后续版本添加)

## dbdiagram.io 表结构代码

将以下代码复制到 https://dbdiagram.io/d 中可视化查看数据库结构：

```sql
// MVP核心表 - 只保留最基本功能

// 节点管理
Table nodes {
  id integer [primary key]
  node_id varchar(64) [unique, not null, note: '节点唯一标识符']
  hostname varchar(255) [not null, note: '主机名']
  ip_address varchar(45) [not null, note: 'IP地址']
  os_info varchar(255) [note: '操作系统信息']
  status varchar(20) [default: 'offline', note: '节点状态: online/offline/error']
  last_heartbeat datetime [note: '最后心跳时间']
  registered_at datetime [default: `now()`, note: '注册时间']
  updated_at datetime [default: `now()`, note: '更新时间']
}

// 监控数据  
Table node_metrics {
  id integer [primary key]
  node_id varchar(64) [not null, note: '关联节点ID']
  metric_time datetime [not null, note: '指标采集时间']
  cpu_usage float [note: 'CPU使用率(%)']
  memory_usage float [note: '内存使用率(%)']  
  disk_usage float [note: '磁盘使用率(%)']
  load_average float [note: '系统负载']
  created_at datetime [default: `now()`]
  
  indexes {
    (node_id, metric_time) [name: 'idx_node_metrics_time']
  }
}

// 命令管理
Table commands {
  id integer [primary key]
  command_id varchar(64) [unique, not null, note: '命令唯一标识符']
  command_text text [not null, note: '命令内容']
  target_node_id varchar(64) [not null, note: '目标节点ID']
  status varchar(20) [default: 'pending', note: '命令状态: pending/running/success/failed/timeout']
  created_at datetime [default: `now()`]
  started_at datetime [note: '开始执行时间']
  completed_at datetime [note: '完成时间']
}

// 命令执行结果
Table command_results {
  id integer [primary key]
  command_id varchar(64) [not null, note: '关联命令ID']
  stdout text [note: '标准输出']
  stderr text [note: '错误输出']
  exit_code integer [note: '退出码']
  execution_time_ms integer [note: '执行耗时(毫秒)']
  created_at datetime [default: `now()`]
}

// 定义外键关系
Ref: node_metrics.node_id > nodes.node_id [delete: cascade]
Ref: commands.target_node_id > nodes.node_id [delete: cascade] 
Ref: command_results.command_id > commands.command_id [delete: cascade]
```

## 表结构说明 (MVP版本)

### 核心表结构 (4张表)

#### 1. nodes (节点表) 
- **主要功能**: 存储节点的基本信息和在线状态
- **核心字段**: 
  - `node_id`: 节点唯一标识符
  - `hostname`: 主机名  
  - `ip_address`: IP地址
  - `status`: 节点状态 (online/offline/error)
  - `last_heartbeat`: 最后心跳时间

#### 2. node_metrics (监控数据表)
- **主要功能**: 存储节点的基础监控指标
- **核心指标**: 
  - `cpu_usage`: CPU使用率
  - `memory_usage`: 内存使用率
  - `disk_usage`: 磁盘使用率
  - `load_average`: 系统负载
- **优化**: 按(node_id, metric_time)建立索引，支持时序查询

#### 3. commands (命令表)
- **主要功能**: 存储要执行的命令信息
- **核心字段**:
  - `command_id`: 命令唯一标识符
  - `command_text`: 要执行的命令
  - `target_node_id`: 目标节点
  - `status`: 命令状态 (pending/running/success/failed/timeout)

#### 4. command_results (命令结果表) 
- **主要功能**: 存储命令的执行结果
- **核心字段**:
  - `stdout`: 标准输出
  - `stderr`: 错误输出  
  - `exit_code`: 退出码
  - `execution_time_ms`: 执行耗时

## MVP设计特点

### 🎯 简化原则
- **最小可行**: 只保留核心功能，去除复杂特性
- **快速开发**: 4张表即可实现基本功能
- **易于理解**: 表结构清晰，关系简单

### 🚀 性能优化  
- **时序索引**: node_metrics表建立时间索引
- **外键关系**: 保证数据一致性
- **适度字段**: 避免过度设计

### 🔄 后续扩展
当MVP验证成功后，可逐步添加：
- 用户权限系统
- 节点分组功能  
- 告警系统
- 审计日志
- 批量命令执行
- 更丰富的监控指标